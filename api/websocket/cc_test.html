<!DOCTYPE html>
<html>

<head>
    <title>WebSocket Example</title>
</head>

<body>
    <h1>WebSocket Example</h1>
    <div style="margin-bottom: 20px;">
        <label for="messageInput">
            Text:
            <input type="text" id="messageInput" placeholder="Type a message">
        </label>
        <button onclick="sendMessage()">Send</button>

        <label for="group_opt">
            Group:
            <select name="group_opt" id="group_opt" onchange="groupChange()">
                <option value="default">default</option>
            </select>
        </label>

        <label for="fileToUpload">
            Media:
            <input type="file" id="fileToUpload">
        </label>
    </div>
    <div id="output">

    </div>

    <script>
        const accessToken = prompt("Enter your user access token"); // Prompt the user for their user ID

        const ws = new WebSocket(`ws://localhost:8081/api/websoket/community-chat/chatting?access_token=${accessToken}`);
        const fileToUpload = document.getElementById("fileToUpload");
        const groupOptions = document.getElementById("group_opt");
        const msgHolder = document.getElementById("output")

        ws.onopen = function (event) {
            const message = JSON.stringify({
                "action": "LoginNotif",
            });
            ws.send(message);

            console.log("Connected!")
        };
        let initialData
        let msg
        ws.onmessage = function (event) {
            try {
                // handle if msg is a json
                data = JSON.parse(event.data)
                msg = data


            } catch {
                // handle if msg is a bytes
                msg.media.blob = event.data
            }

            if (data.action == "Chat" || data.action == "ChatRestore") {
                if (data.withMedia == true && !data.media.blob) {
                    // skip to next msg to get the media blob
                    return true
                }
                let mediaElement = ""

                if (msg.withMedia == true) {
                    const mediaType = msg.media.type
                    const imageValidate = /image/
                    const audioValidate = /audio/
                    const videoValidate = /video/
                    
                    if (imageValidate.test(mediaType)) {
                        var urlCreator = window.URL || window.webkitURL;
                        var imageUrl = urlCreator.createObjectURL(msg.media.blob);

                        mediaElement = `<img src="${imageUrl}" alt="" width="25%" height="25%">`
                    }

                    if(audioValidate.test(mediaType)) {
                        var urlCreator = window.URL || window.webkitURL;
                        var audioUrl = urlCreator.createObjectURL(msg.media.blob);

                        mediaElement = `
                        <audio controls style="width: 18%;">
                            <source src="${audioUrl}" type="${mediaType}">
                            Your browser does not support the audio element.
                        </audio>
                        `
                    }

                    if(videoValidate.test(mediaType)) {
                        var urlCreator = window.URL || window.webkitURL;
                        var videoUrl = urlCreator.createObjectURL(msg.media.blob);

                        mediaElement = `
                        <video controls style="width: 18%;">
                            <source src="${videoUrl}" type="${mediaType}">
                            Your browser does not support the video element.
                        </video>
                        `
                    }
                }

                message = `
                <span id="msgSender"><b>${msg.sender}:</b></span>
                <span id="msgText">${msg.text}</span>
                <div id="mediaPlace" style="">
                    ${mediaElement}
                </div>
                `
                msgContainer = document.createElement("div")
                msgContainer.innerHTML = message

                msgHolder.appendChild(msgContainer)
            }

            if (data.action == "InitialData") {
                initialData = data

                for (const group of data.group_list) {
                    const option = document.createElement("option");
                    option.value = group;
                    option.text = group;
                    groupOptions.appendChild(option);
                }
            }
            console.log(msg)



        };

        function sendMessage() {
            const messageInput = document.getElementById("messageInput");
            const now = new Date();
            let withMedia = false

            if (fileToUpload.value != "") {
                withMedia = true
            }

            data = {
                "action": "Chat",
                "text": messageInput.value,
                "group": groupOptions.value,
                "withMedia": withMedia
            }

            if (withMedia == true) {
                data["media"] = {
                    "type": fileToUpload.files[0].type,
                }
            }

            const message = JSON.stringify(data);

            ws.send(message);
            if (withMedia == true) {
                sendMedia()
            }
            messageInput.value = "";
        }


        function sendMedia() {
            ws.send(fileToUpload.files[0])
            fileToUpload.value = ""
        }

        function groupChange() {            
            ws.send(JSON.stringify({
                "action": "GroupChange",
                "currentGroup": groupOptions.value
            }))
            msgHolder.innerHTML = ""
            console.clear()
            console.log("groub have changed!")
        }

    </script>
</body>

</html>